

{% extends "base.html" %}

{% block title %}Startup Scripts{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="mt-4 text-3xl font-bold">Startup Scripts</h1>
            <p class="text-gray-400">Configure scripts to run automatically when your Lightning AI Studio starts.</p>
        </div>
        <div class="flex gap-4">
            <button type="button" class="btn btn-primary" onclick="saveConfig()">
                <i class="fas fa-save mr-2"></i>Save Configuration
            </button>
            <button type="button" class="btn btn-secondary" onclick="executeNow()">
                <i class="fas fa-play-circle mr-2"></i>Execute Now
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
        <!-- Configuration Column -->
        <div class="flex flex-col gap-6">
            <div class="card bg-gray-800 rounded-lg shadow-lg">
                <div class="card-body p-6">
                    <form id="startup-script-form">
                        <div class="flex items-center justify-between mb-4">
                            <label for="enabled" class="font-semibold text-lg">Enable Startup Scripts</label>
                            <input type="checkbox" id="enabled" class="form-checkbox h-6 w-6 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        </div>
                        <hr class="border-gray-600 my-4">
                        <div class="flex items-center justify-between">
                            <label for="debug_mode" class="font-semibold text-lg">Enable Debug Mode</label>
                            <input type="checkbox" id="debug_mode" class="form-checkbox h-6 w-6 text-yellow-500 bg-gray-700 border-gray-600 rounded focus:ring-yellow-500">
                        </div>
                    </form>
                </div>
            </div>

            <div class="card bg-gray-800 rounded-lg shadow-lg">
                <div class="card-header bg-gray-700 px-6 py-4 border-b border-gray-600">
                    <h2 class="text-xl font-semibold">Files to Upload</h2>
                    <p class="text-sm text-gray-400">Enter the full local path for each file on a new line.</p>
                </div>
                <div class="card-body p-6">
                    <textarea id="files" class="w-full h-48 bg-gray-900 text-white font-mono p-4 rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            </div>

            <div class="card bg-gray-800 rounded-lg shadow-lg">
                <div class="card-header bg-gray-700 px-6 py-4 border-b border-gray-600">
                    <h2 class="text-xl font-semibold">Commands to Execute</h2>
                    <p class="text-sm text-gray-400">Enter each command on a new line.</p>
                </div>
                <div class="card-body p-6">
                    <textarea id="commands" class="w-full h-64 bg-gray-900 text-white font-mono p-4 rounded-lg border border-gray-600 focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            </div>
        </div>

        <!-- Execution Column -->
        <div class="card bg-gray-800 rounded-lg shadow-lg">
            <div class="card-header bg-gray-700 px-6 py-4 border-b border-gray-600 flex justify-between items-center">
                <h2 class="text-xl font-semibold">Execution Status & Output</h2>
                <div id="execution-status-indicator" class="flex items-center gap-2 text-sm font-semibold"></div>
            </div>
            <div class="card-body p-6">
                <div id="execution-output" class="bg-black text-white p-4 rounded-lg font-mono text-sm" style="min-height: 400px; max-height: 600px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let executionInterval;

    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/startup-scripts/config')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('enabled').checked = data.config.enabled;
                    document.getElementById('files').value = data.config.files.join('\n');
                    document.getElementById('commands').value = data.config.commands;
                    document.getElementById('debug_mode').checked = data.config.debug_mode;
                }
            });
    });

    function saveConfig() {
        const config = {
            enabled: document.getElementById('enabled').checked,
            files: document.getElementById('files').value.split('\n').filter(f => f.trim() !== ''),
            commands: document.getElementById('commands').value,
            debug_mode: document.getElementById('debug_mode').checked
        };

        fetch('/api/startup-scripts/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(config)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Configuration saved successfully.', 'success');
            } else {
                showNotification(`Error: ${data.error}`, 'error');
            }
        });
    }

    function executeNow() {
        setExecutionStatus('running', 'Executing startup script...');
        document.getElementById('execution-output').innerHTML = '';
        if (executionInterval) {
            clearInterval(executionInterval);
        }

        fetch('/api/startup-scripts/execute', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Execution started. Polling for output...', 'info');
                pollExecutionOutput(data.execution_id);
            } else {
                setExecutionStatus('failed', `Error: ${data.error}`);
            }
        });
    }

    function pollExecutionOutput(executionId) {
        executionInterval = setInterval(() => {
            fetch(`/api/startup-scripts/output/${executionId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const outputHtml = data.output.split('\n').map(line => {
                            let color = 'text-gray-300';
                            if (line.toLowerCase().includes('error') || line.toLowerCase().includes('failed')) {
                                color = 'text-red-400';
                            } else if (line.toLowerCase().includes('success') || line.toLowerCase().includes('completed')) {
                                color = 'text-green-400';
                            }
                            return `<div class="${color}">${line}</div>`;
                        }).join('');
                        document.getElementById('execution-output').innerHTML = outputHtml;

                        if (data.status === 'completed' || data.status === 'failed') {
                            clearInterval(executionInterval);
                            setExecutionStatus(data.status, `Execution ${data.status}.`);
                        }
                    }
                    else {
                        clearInterval(executionInterval);
                        setExecutionStatus('failed', `Error polling for output: ${data.error}`);
                    }
                });
        }, 2000);
    }

    function setExecutionStatus(status, message) {
        const indicator = document.getElementById('execution-status-indicator');
        let statusHtml = '';

        if (status === 'running') {
            statusHtml = `<i class="fas fa-spinner fa-spin text-yellow-400 mr-2"></i> <span class="text-yellow-400">${message}</span>`;
        } else if (status === 'completed') {
            statusHtml = `<i class="fas fa-check-circle text-green-400 mr-2"></i> <span class="text-green-400">${message}</span>`;
        } else if (status === 'failed') {
            statusHtml = `<i class="fas fa-times-circle text-red-400 mr-2"></i> <span class="text-red-400">${message}</span>`;
        } else {
            statusHtml = `<i class="fas fa-question-circle text-gray-400 mr-2"></i> <span class="text-gray-400">${message}</span>`;
        }
        indicator.innerHTML = statusHtml;
    }
</script>
{% endblock %}
